<?php
include_once "../libs/conn.php";
include_once '../libs/budgetDB.php'; 
include_once 'chinese.php';
include_once 'pdf_chinese.php';
global $custName ;
global $projectName ;
$budget = getBudgetsByBudgetId($_REQUEST["budgetId"]);
$custName =  str2GBK(urldecode($budget[0]["custName"]));
$projectName = str2GBK(urldecode($budget[0]["projectName"]));
$action = isset($_REQUEST["action"]) ? $_REQUEST["action"] : "download";

$budgetItems = getBudgetItemsByBudgetIdGBK($_REQUEST["budgetId"]);
$pdf=new PDF('L','mm', 'A4'); //创建新的FPDF对象 
$pdf->AddGBFont(); //设置中文字体 
$pdf->Open(); //开始创建PDF 
$pdf->AddPage(); //增加一页 
$pdf->SetFont('GB','',10); //设置字体样式 

$CellWidth  = array(   30,   50,   20,   20,	14,	   18,    14,    18,    14,    18,    14,    18,    22);
$lineHeight = 10;
ksort($budgetItems);
$arrayForTotalCount = array("ATotal"=>0,"BTotal"=>0,"CTotal"=>0,"DTotal"=>0,"A"=>0,"B"=>0,"C"=>0,"D"=>0);
$isFirstTime = true;
foreach($budgetItems as $bItem){
	$amount = $bItem["itemAmount"];
	//通过单位为空判断是否是大项
	$isBigSubject = ("NULL" === $bItem["itemUnit"]);
	$mainMaterialPrice = $amount * ( $bItem["mainMaterialPrice"] + $bItem["lossPercent"] );
	$auxiliaryMaterialPrice = $amount*$bItem["auxiliaryMaterialPrice"];
	$manpowerPrice = $amount*$bItem["manpowerPrice"];
	$machineryPrice = $amount*$bItem["machineryPrice"];
	//一个大项
	if($isBigSubject){
		if($isFirstTime){
			$isFirstTime = false; // 第一次不输出小计
		}else{
			$data = array('','小计','','','',$arrayForTotalCount["A"],'',$arrayForTotalCount["B"],'',$arrayForTotalCount["C"],'',$arrayForTotalCount["D"],'');
			$pdf->writeCellLine($CellWidth,$lineHeight,$data,1,0,'C');
			$pdf->writeCellLine($CellWidth,$lineHeight,"",1,0,'C');  // 空一行
			$arrayForTotalCount["ATotal"] += $arrayForTotalCount["A"];
			$arrayForTotalCount["BTotal"] += $arrayForTotalCount["B"];
			$arrayForTotalCount["CTotal"] += $arrayForTotalCount["C"];
			$arrayForTotalCount["DTotal"] += $arrayForTotalCount["D"];
			$arrayForTotalCount["A"] = 0;
			$arrayForTotalCount["B"] = 0;
			$arrayForTotalCount["C"] = 0;
			$arrayForTotalCount["D"] = 0;
		}
	}
	$arrayForTotalCount["A"] += $mainMaterialPrice;
	$arrayForTotalCount["B"] += $auxiliaryMaterialPrice;
	$arrayForTotalCount["C"] += $manpowerPrice;
	$arrayForTotalCount["D"] += $machineryPrice;

	
	$data = array($bItem["itemCode"],$bItem["itemName"],'','','','','','','','','','','');
	if(!$isBigSubject){
		$data = array($bItem["itemCode"],$bItem["itemName"],$bItem["itemUnit"],
					$amount,$bItem["mainMaterialPrice"],$mainMaterialPrice,
					$bItem["auxiliaryMaterialPrice"],$auxiliaryMaterialPrice,$bItem["manpowerPrice"],
					$manpowerPrice,$bItem["machineryPrice"],$machineryPrice,
					$bItem["lossPercent"]);
	}
	$pdf->writeCellLine($CellWidth,$lineHeight,$data,1,0,'C');
}

//输出小计
$data = array('','小计','','','',$arrayForTotalCount["A"],'',$arrayForTotalCount["B"],'',$arrayForTotalCount["C"],'',$arrayForTotalCount["D"],'');
$pdf->writeCellLine($CellWidth,$lineHeight,$data,1,0,'C');
$pdf->writeCellLine($CellWidth,$lineHeight,"",1,0,'C');  // 空一行
//输出总计
$data = array('','总计','','','',$arrayForTotalCount["ATotal"],'',$arrayForTotalCount["BTotal"],'',$arrayForTotalCount["CTotal"],'',$arrayForTotalCount["DTotal"],'');
$pdf->writeCellLine($CellWidth,$lineHeight,$data,1,0,'C');

//输出其他
$titleHeightPosition = 7;
$pdf->SetFont('GB','',9); //设置字体样式 
$pdf->Ln();
$pdf->Cell(11,21,"");
$pdf->Cell(200,$titleHeightPosition,'    1、 本预算不含税金。',0);
$pdf->SetFont('GB','',10); //设置字体样式 
$pdf->Cell(21,$titleHeightPosition,'客户签字：',0);
$pdf->SetFont('GB','',9); //设置字体样式 
$pdf->Ln();
$pdf->Cell(11,21,"");
$pdf->Cell(200,$titleHeightPosition,'    2、 本预算不含施工用水电费（ 甲方提供）');
$pdf->Ln();
$pdf->Cell(11,21,"");
$pdf->Cell(200,$titleHeightPosition,'    3、 本预算不含物业管理部门的任何费用。');
$pdf->SetFont('GB','',10); //设置字体样式 
$pdf->Cell(21,$titleHeightPosition,'时间：',0,0,'R');
$pdf->Cell(16,$titleHeightPosition,'年',0,0,'R');
$pdf->Cell(11,$titleHeightPosition,'月',0,0,'R');
$pdf->Cell(11,$titleHeightPosition,'日',0,0,'R');
$pdf->SetFont('GB','',9); //设置字体样式 
$pdf->Ln();
$pdf->Cell(11,21,"");
$pdf->Cell(200,$titleHeightPosition,'    4、 本预算不含灯具、 洁具、 龙头、 淋浴房及挡水条、 地漏， 移门轨道、 门锁、 拉手、 金属脚、 开关面板、');
$pdf->Ln();
$pdf->Cell(11,21,"");
$pdf->Cell(200,$titleHeightPosition,'           瓷砖、 石材、 地板及安装、 成品门. 门套及安装， 墙纸及施工， 地毯、 楼梯、 阳光棚璃等、 非预算内的项目另计。');
$pdf->Ln();
$pdf->Cell(11,21,"");
$pdf->Cell(200,$titleHeightPosition,'    注： 1、 本报价单为合同附件， 具有同等法律效力， 业主签字后生效。');
$pdf->Ln();
$pdf->Output($projectName.".pdf", $action == "view" ? "I" : "D" );



/*
$CellWidth  = array(30,50,20,20,14,18,14,18,14,18,18,18,18);
$pdf->Ln();
$data = array('','','','','','','','','','','','','');
$pdf->writeCellLine($CellWidth,$lineHeight,$data,0,0,'R');
$pdf->Ln();
$data = array('','','','','','','','','','时间：','年','月','日');*/
$pdf->writeCellLine($CellWidth,$lineHeight,$data,0,0,'R');

?>  