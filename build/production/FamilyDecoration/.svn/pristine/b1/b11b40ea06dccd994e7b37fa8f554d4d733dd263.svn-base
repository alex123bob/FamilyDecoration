<?php
global $CellWidth,$FirstCellWidth,$titleLeft; 
$FirstCellWidth  = array(20,40,20,20,   37,   37,   37,   37,22);
$CellWidth 		 = array(20,40,20,20,14,23,14,23,14,23,14,23,22);
$titleLeft       = array(17,43,77,97);
include_once "../libs/conn.php";
include_once '../libs/budgetDB.php'; 
include_once 'chinese.php';
include_once 'pdf_chinese.php';
global $custName;
global $projectName;
$budget = getBudgetsByBudgetId($_REQUEST["budgetId"]);
$custName =  str2GBK(urldecode($budget[0]["custName"]));
$projectName = str2GBK(urldecode($budget[0]["projectName"]));
$action = isset($_REQUEST["action"]) ? $_REQUEST["action"] : "download";
//不能放在for循环中，需要单独处理的项
$otherInfo = array('N','O','P','Q','R','S');
$otherInfoArray = array();
$budgetItems = getBudgetItemsByBudgetIdGBK($_REQUEST["budgetId"]);
$pdf=new PDF('L','mm', 'A4'); //创建新的FPDF对象 
$pdf->AddGBFont(); //设置中文字体 
$pdf->Open(); //开始创建PDF 
$pdf->AddPage(); //增加一页 
$pdf->SetFont('GB','',10); //设置字体样式 
$pdf->AliasNbPages("__totalPage__");

$lineHeight = 10;
ksort($budgetItems);
$totalFee = array("ATotal"=>0,"BTotal"=>0,"CTotal"=>0,"DTotal"=>0,"A"=>0,"B"=>0,"C"=>0,"D"=>0);
$isFirstTime = true;
foreach($budgetItems as $bItem){
	$itemName = $bItem["itemName"];
	$amount = $bItem["itemAmount"];
	$itemCode = $bItem["itemCode"];
	//最后需要特殊处理的几项不参与循环，放在后面单独处理
	if(in_array($itemCode,$otherInfo)){
		array_push($otherInfoArray,$bItem);
		continue;
	}
	//可能出线为空的空白数据，不参与计算，此处防止多出线为空的小计
	if("NULL" === $itemName || "" === $itemName || "NULL" === $itemCode || "" === $itemCode ){
		continue;
	}
	//通过单位为空判断是否是大项
	$isBigSubject = ("NULL" === $bItem["itemUnit"]);
	$mainMaterialPrice = $amount * ( $bItem["mainMaterialPrice"] + $bItem["lossPercent"] );
	$auxiliaryMaterialPrice = $amount*$bItem["auxiliaryMaterialPrice"];
	$manpowerPrice = $amount*$bItem["manpowerPrice"];
	$machineryPrice = $amount*$bItem["machineryPrice"];
	//一个大项
	if($isBigSubject){
		if($isFirstTime){
			$isFirstTime = false; // 第一次不输出小计
		}else{
			//输出小计
			$data = array('','小计','','','',$totalFee["A"],'',$totalFee["B"],'',$totalFee["C"],'',$totalFee["D"],'');
			$pdf->writeCellLine($CellWidth,$lineHeight,$data,1,0,'C');
			$pdf->writeCellLine($CellWidth,$lineHeight,"",1,0,'C');  // 空一行
			//总计累加
			$totalFee["ATotal"] += $totalFee["A"];
			$totalFee["BTotal"] += $totalFee["B"];
			$totalFee["CTotal"] += $totalFee["C"];
			$totalFee["DTotal"] += $totalFee["D"];
			//小计清空
			$totalFee["A"] = 0;
			$totalFee["B"] = 0;
			$totalFee["C"] = 0;
			$totalFee["D"] = 0;
		}
	}
	//累加计算小计
	$totalFee["A"] += $mainMaterialPrice;
	$totalFee["B"] += $auxiliaryMaterialPrice;
	$totalFee["C"] += $manpowerPrice;
	$totalFee["D"] += $machineryPrice;

	//正常输出大、小项数据
	if($isBigSubject){
		$data = array($itemCode,$itemName,'','','','','','','','','','','');
	}else{
		$data = array($itemCode,$itemName,$bItem["itemUnit"],
			$amount,$bItem["mainMaterialPrice"],$mainMaterialPrice,
			$bItem["auxiliaryMaterialPrice"],$auxiliaryMaterialPrice,$bItem["manpowerPrice"],
			$manpowerPrice,$bItem["machineryPrice"],$machineryPrice,
			$bItem["lossPercent"]);
	}
	//输出一行数据
	$pdf->writeCellLine($CellWidth,$lineHeight,$data,1,0,'C');
}

//输出小计
$data = array('','小计','','','',$totalFee["A"],'',$totalFee["B"],'',$totalFee["C"],'',$totalFee["D"],'');
$pdf->writeCellLine($CellWidth,$lineHeight,$data,1,0,'C');
$pdf->writeCellLine($CellWidth,$lineHeight,"",1,0,'C');  // 空一行
$totalFee["ATotal"] += $totalFee["A"];
$totalFee["BTotal"] += $totalFee["B"];
$totalFee["CTotal"] += $totalFee["C"];
$totalFee["DTotal"] += $totalFee["D"];
//输出特殊处理项
//不使用数据库里的工程直接费和工程总造价，自己算
$projectFee = $totalFee["ATotal"]+$totalFee["BTotal"]+$totalFee["CTotal"]+$totalFee["DTotal"];
$data = array('N','工程直接费','元','1','',$projectFee,'','','','','','','');
$pdf->writeCellLine($CellWidth,$lineHeight,$data,1,0,'C');
ksort($otherInfoArray);
foreach($otherInfoArray as $bItem){
	$itemCode = $bItem["itemCode"];
	//不使用数据库里的工程直接费和工程总造价，自己算
	if($itemCode == "N" || $itemCode == "S"){
		continue;
	}
	$amount = $bItem["itemAmount"];
	$price = $bItem["mainMaterialPrice"];
	$totalPrice = $price * $amount;
	$projectFee += $totalPrice;
	$data = array($itemCode,$bItem["itemName"],$bItem["itemUnit"],$amount,$price ,$totalPrice,"","","","","","","");
	$totalFee["ATotal"] += $totalFee["A"];
	$totalFee["BTotal"] += $totalFee["B"];
	$totalFee["CTotal"] += $totalFee["C"];
	$totalFee["DTotal"] += $totalFee["D"];
	$pdf->writeCellLine($CellWidth,$lineHeight,$data,1,0,'C');
}
//输出总计
//不使用数据库里的工程直接费和工程总造价，自己算
$data = array('S','工程总造价','元','1','',$projectFee,'','','','','','','');
$pdf->writeCellLine($CellWidth,$lineHeight,$data,1,0,'C');

//输出其他
$titleHeightPosition = 7;
$pdf->SetFont('GB','',9); //设置字体样式 
$pdf->Ln();
$pdf->Cell(11,10,"");
$pdf->Ln();
$pdf->Cell(11,21,"");
$pdf->Cell(200,$titleHeightPosition,'    1、 本预算不含税金。',0);
$pdf->SetFont('GB','',10); //设置字体样式 
$pdf->Cell(21,$titleHeightPosition,'客户签字：',0);
$pdf->SetFont('GB','',9); //设置字体样式 
$pdf->Ln();
$pdf->Cell(11,21,"");
$pdf->Cell(200,$titleHeightPosition,'    2、 本预算不含施工用水电费（ 甲方提供）');
$pdf->Ln();
$pdf->Cell(11,21,"");
$pdf->Cell(200,$titleHeightPosition,'    3、 本预算不含物业管理部门的任何费用。');
$pdf->SetFont('GB','',10); //设置字体样式 
$pdf->Cell(21,$titleHeightPosition,'时间：',0,0,'R');
$pdf->Cell(16,$titleHeightPosition,'年',0,0,'R');
$pdf->Cell(11,$titleHeightPosition,'月',0,0,'R');
$pdf->Cell(11,$titleHeightPosition,'日',0,0,'R');
$pdf->SetFont('GB','',9); //设置字体样式 
$pdf->Ln();
$pdf->Cell(11,21,"");
$pdf->Cell(200,$titleHeightPosition,'    4、 本预算不含灯具、 洁具、 龙头、 淋浴房及挡水条、 地漏， 移门轨道、 门锁、 拉手、 金属脚、 开关面板、');
$pdf->Ln();
$pdf->Cell(11,21,"");
$pdf->Cell(200,$titleHeightPosition,'           瓷砖、 石材、 地板及安装、 成品门. 门套及安装， 墙纸及施工， 地毯、 楼梯、 阳光棚璃等、 非预算内的项目另计。');
$pdf->Ln();
$pdf->Cell(11,21,"");
$pdf->Cell(200,$titleHeightPosition,'    注： 1、 本报价单为合同附件， 具有同等法律效力， 业主签字后生效。');
$pdf->Ln();
$pdf->Output($projectName.".pdf", $action == "view" ? "I" : "D" );

$pdf->writeCellLine($CellWidth,$lineHeight,$data,0,0,'R');

?>  