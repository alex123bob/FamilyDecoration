<?php
	// ---end of the page
	function addBudget($post){
		$count = count(getBudgetsByProjectName($_REQUEST["projectName"]));
		if($count > 0) 
			throw new Exception("项目 : '".$_REQUEST["projectName"]."' 已经存在!");
		$obj = array(
			"budgetId" => "budget-".date("YmdHis").str_pad(rand(0, 9999), 4, rand(0, 9), STR_PAD_LEFT),
			"projectName"=>$post["projectName"],
			"custName"=>$post["custName"],
			"areaSize"=>$post["areaSize"],
			"totalFee"=>$post["totalFee"],
			"comments"=>$post["comments"],
			"isDeleted"=>false
		);
		global $mysql;
		$mysql->DBInsertAsArray("`budget`",$obj);
		return array('status'=>'successful', 'errMsg' => '');
	}

	function addBugetItem($post){
		foreach ($post as $key => $value) {
			$post[$key] = explode(">>><<<", $value);
		}
		$len = count($post["itemName"]);

		global $mysql;

		for ($i = 0; $i < $len; $i++) {
			$obj = array(
				"budgetItemId" => "budget-item-".date("YmdHis").str_pad(rand(0, 9999), 4, rand(0, 9), STR_PAD_LEFT),
				"itemName"=>$post["itemName"][$i],
				"budgetId"=>$post["budgetId"][$i],
				"itemCode"=>$post["itemCode"][$i],
				"itemUnit"=>$post["itemUnit"][$i],
				"itemAmount"=>($post["itemAmount"][$i] ),
				"mainMaterialPrice"=>($post["mainMaterialPrice"][$i] ),
				"auxiliaryMaterialPrice"=>($post["auxiliaryMaterialPrice"][$i] ),
				"manpowerPrice"=>($post["manpowerPrice"][$i] ),
				"machineryPrice"=>($post["machineryPrice"][$i] ),
				"lossPercent"=>($post["lossPercent"][$i] ),
				"isDeleted"=>false,
				"remark"=>$post["remark"][$i],
			);
			$mysql->DBInsertAsArray("`budget_item`",$obj);
		}
		
		return array('status'=>'successful', 'errMsg' => '');
	}
	
	function delBudget ($id){
		global $mysql;
		$condition = "`budgetId` = '$id' ";
		$setValue = " `isDeleted` = 'true'";
		$mysql->DBUpdateSomeCols("`Budget`", $condition, $setValue);
		return array('status'=>'successful', 'errMsg' => '');
	}
	function delBudgetItem($ItemId){
		global $mysql;
		$condition = "`budgetItemId` = '$ItemId' ";
		$setValue = " `isDeleted` = 'true'";
		$mysql->DBUpdateSomeCols("`budget_item`", $condition, $setValue);
		return array('status'=>'successful', 'errMsg' => '');
	}
	function getBudgets (){
		global $mysql;
		$res= array();
		$arr = $mysql->DBGetSomeRows("`budget`", "*", " where `isDeleted` = 'false' ");
		foreach($arr as $key => $val) {
			$res[$key]['projectName'] = urlencode($val['projectName']);
			$res[$key]['budgetId'] = urlencode($val['budgetId']);
			$res[$key]['custName'] = urlencode($val['custName']);
			$res[$key]['areaSize'] = urlencode($val['areaSize']);
			$res[$key]['totalFee'] = urlencode($val['totalFee']);
			$res[$key]['comments'] = urlencode(addslashes($val['comments']));
		}
		return $res;
	}
	
	function getBudgetsByBudgetId ($budgetId){
		global $mysql;
		$res= array();
		$arr = $mysql->DBGetSomeRows("`budget`", "*", "where `budgetId` = '$budgetId' ");
		foreach($arr as $key => $val) {
			$res[$key]['projectName'] = urlencode($val['projectName']);
			$res[$key]['budgetId'] = urlencode($val['budgetId']);
			$res[$key]['custName'] = urlencode($val['custName']);
			$res[$key]['areaSize'] = urlencode($val['areaSize']);
			$res[$key]['totalFee'] = urlencode($val['totalFee']);
			$res[$key]['comments'] = urlencode(addslashes($val['comments']));
		}
		return $res;
	}

	function getBudgetItemsByBudgetId ($budgetId , $isGBK = false) {
		global $mysql;
		$res= array();
		$arr = $mysql->DBGetSomeRows("`budget_item`", "*", "where `budgetId` = '$budgetId' and `isDeleted` = 'false' "," order by itemCode asc");
		$count = 0;
		$smallCount = array(0,0,0,0);
		foreach($arr as $val) {
			$itemCode = $val['itemCode'];
			$itemUnit = $val['itemUnit'];
			$itemAmount = $val['itemAmount'];
			$budgetId = $val['budgetId'];
			// itemCode  长度为1时认为是大项 //在N之前输出一次小计，A之前不输出
			if((strlen($itemCode) == 1 && !in_array($itemCode,array('A','O','P','Q','R','S')))){
				//增加一行小计
				$res[$count++] = array('budgetItemId'=>'NULL'.$count,'itemName'=>$isGBK ? str2GBK('小计') : urlencode('小计'),'budgetId'=>$budgetId,
								'itemCode'=>'','itemUnit'=>'','itemAmount'=>'','mainMaterialPrice'=>'','auxiliaryMaterialPrice'=>'','manpowerPrice'=>'',
								'machineryPrice'=>'','mainMaterialTotalPrice'=>$smallCount[0],'auxiliaryMaterialTotalPrice'=>$smallCount[1],
								'manpowerTotalPrice'=>$smallCount[2],'machineryTotalPrice'=>$smallCount[3],'lossPercent'=>'','remark'=>'');
				$smallCount = array(0,0,0,0);
			}
			if($itemCode == 'N'){
				//增加一行空行
				$res[$count++] = array('budgetItemId'=>'NULL'.$count,'itemName'=>'','budgetId'=>$budgetId,'itemCode'=>'','itemUnit'=>'','itemAmount'=>'',
								'mainMaterialPrice'=>'','auxiliaryMaterialPrice'=>'','manpowerPrice'=>'','machineryPrice'=>'','mainMaterialTotalPrice'=>'',
								'auxiliaryMaterialTotalPrice'=>'','manpowerTotalPrice'=>'','machineryTotalPrice'=>'','lossPercent'=>'','remark'=>'');
			}
			//正常输出项
			$res[$count]['budgetItemId'] = $val['budgetItemId'];
			$res[$count]['itemName'] = $isGBK ? str2GBK($val['itemName']) :  urlencode($val['itemName']);
			$res[$count]['budgetId'] = $val['budgetId'];
			$res[$count]['itemCode'] = $val['itemCode'];
			$res[$count]['itemUnit'] = $isGBK ? str2GBK($val['itemUnit']) :  urlencode($val['itemUnit']);
			$res[$count]['itemAmount'] = $itemAmount;
			$res[$count]['mainMaterialPrice'] = $val['mainMaterialPrice'];
			$res[$count]['auxiliaryMaterialPrice'] = $val['auxiliaryMaterialPrice'];
			$res[$count]['manpowerPrice'] = $val['manpowerPrice'];
			$res[$count]['machineryPrice'] = $val['machineryPrice'];
			$res[$count]['lossPercent'] = $val['lossPercent'];
			$res[$count]['mainMaterialTotalPrice'] = $itemAmount * ($val['mainMaterialPrice'] + $val['lossPercent']);
			$res[$count]['auxiliaryMaterialTotalPrice'] =  $itemAmount * $val['auxiliaryMaterialPrice'];
			$res[$count]['manpowerTotalPrice'] = $itemAmount * $val['manpowerPrice'];
			$res[$count]['machineryTotalPrice'] = $itemAmount * $val['machineryPrice'];
			$res[$count]['remark'] = $val['remark'] == 'NULL' ? '' : ($isGBK ? str2GBK($val['remark']) :  urlencode(addslashes(nl2br(str_replace("\n", "<br />", $val['remark'])))));
			$smallCount[0] +=  $itemAmount * ($val['mainMaterialPrice'] + $val['lossPercent']);
			$smallCount[1] +=  $itemAmount * $val['auxiliaryMaterialPrice'];
			$smallCount[2] +=  $itemAmount * $val['manpowerPrice'];
			$smallCount[3] +=  $val['itemAmount'] * $val['machineryPrice'];
			//如果是大项的话，有些字段要清空
			if(strlen($itemCode) == 1){
				if(!in_array($itemCode,array('N','O','P','Q','R','S'))){
					$res[$count]['itemUnit'] = '';
					$res[$count]['mainMaterialTotalPrice'] = '';
					$res[$count]['itemAmount'] = '';
				}
				$res[$count]['mainMaterialPrice'] = '';
				$res[$count]['auxiliaryMaterialPrice'] = '';
				$res[$count]['manpowerPrice'] = '';
				$res[$count]['machineryPrice'] = '';
				$res[$count]['auxiliaryMaterialTotalPrice'] = '';
				$res[$count]['manpowerTotalPrice'] = '';
				$res[$count]['machineryTotalPrice'] = '';
				$res[$count]['lossPercent'] = '';
				$res[$count]['remark'] = '';
			}
			$count++;
		}
		return $res;
	}
	function compareBudgetItem($arg1,$arg2){
		return strcasecmp($arg1["itemCode"],$arg2["itemCode"]);
	}
	function getBudgetsByProjectName ($projectName){
		global $mysql;
		$res= array();
		$arr = $mysql->DBGetSomeRows("`budget`", "*", "where `projectName` = '$projectName' and `isDeleted` = 'false' ");
		foreach($arr as $key => $val) {
			$res[$key]['projectName'] = urlencode($val['projectName']);
			$res[$key]['budgetId'] = urlencode($val['budgetId']);
			$res[$key]['custName'] = urlencode($val['custName']);
			$res[$key]['areaSize'] = urlencode($val['areaSize']);
			$res[$key]['totalFee'] = urlencode($val['totalFee']);
			$res[$key]['comments'] = urlencode(addslashes($val['comments']));
		}
		return $res;
	}

	function editBudget (array $pro){
		global $mysql;
		$setValue = "";
		foreach ($pro as $key => $val) {
			if ($key == "budgetId" || is_numeric ($key)) {
				continue;
			} else {
				$setValue .= " `".$key."` = '".$val."',";
			}
		}
		$setValue = substr($setValue, 0, -1);
		$condition = "`budgetId` = '".$pro['budgetId']."'";
		$mysql->DBUpdateSomeCols("`Budget`", $condition, $setValue);
		return array('status'=>'successful', 'errMsg' => '');
	}
?>