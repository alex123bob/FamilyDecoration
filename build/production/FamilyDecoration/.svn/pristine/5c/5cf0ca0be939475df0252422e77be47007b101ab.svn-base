<?php
	include_once "conn.php";
	$action = $_REQUEST["action"];
	$res = "";
	switch($action){
		case "list": 	$res = getBudgets();  break;
		case "add":  	$res = addBudget($_REQUEST);  break;
		case "addItem":	$res = addBugetItem($_REQUEST);  break;;
		case "deleItem":$res = delBudgetItem($_REQUEST["ItemId"]);  break;;
		case "edit":	$res = editBudget($_REQUEST);  break;;
		case "delete":	$res = delBudget($_REQUEST["budgetId"]);  break;;
		case "view":	$res = getBudgetsByBudgetId($_REQUEST["budgetId"]);  break;
		case "getBudgetsByProjectName":	$res = getBudgetsByProjectName($_REQUEST["projectName"]);  break;
		default: 		throw new Exception("unknown action:".$action);
	}
	echo urldecode(json_encode($res));

	// ---end of the page
	function addBudget($post){
	
		$count = count(getBudgetsByProjectName($_REQUEST["projectName"]));
		if($count > 0) 
			throw new Exception("project : '".$_REQUEST["projectName"]."' already exist!");
		$obj = array(
			"budgetId" => date("YmdHis").str_pad(rand(0, 9999), 4, rand(0, 9), STR_PAD_LEFT),
			"projectName"=>$post["projectName"],
			"custName"=>$post["custName"],
			"areaSize"=>$post["areaSize"],
			"totalFee"=>$post["totalFee"],
			"comments"=>$post["comments"],
			"isDeleted"=>false
		);
		global $mysql;
		$mysql->DBInsertAsArray("`Budget`",$obj);
		return array('status'=>'successful', 'errMsg' => '');
	}

	function addBugetItem($post){
		$obj = array(
			"budgetItemId" => date("YmdHis").str_pad(rand(0, 9999), 4, rand(0, 9), STR_PAD_LEFT),
			"itemName"=>$post["itemName"],
			"budgetId"=>$post["budgetId"],
			"itemCode"=>$post["itemCode"],
			"itemUnit"=>$post["itemUnit"],
			"itemAmount"=>$post["itemAmount"],
			"mainMaterialPrice"=>$post["mainMaterialPrice"],
			"auxiliaryMaterialPrice"=>$post["auxiliaryMaterialPrice"],
			"manpowerPrice"=>$post["manpowerPrice"],
			"machineryPrice"=>$post["machineryPrice"],
			"lossPercent"=>$post["lossPercent"],
			"isDeleted"=>false
		);
		global $mysql;
		$mysql->DBInsertAsArray("`budget_item`",$obj);
		return array('status'=>'successful', 'errMsg' => '');
	}
	
	function delBudget ($id){
		global $mysql;
		$condition = "`budgetId` = '$id' ";
		$setValue = " `isDeleted` = 'true'";
		$mysql->DBUpdateSomeCols("`Budget`", $condition, $setValue);
		return array('status'=>'successful', 'errMsg' => '');
	}
	function delBudgetItem($ItemId){
		global $mysql;
		$condition = "`budgetItemId` = '$ItemId' ";
		$setValue = " `isDeleted` = 'true'";
		$mysql->DBUpdateSomeCols("`budget_item`", $condition, $setValue);
		return array('status'=>'successful', 'errMsg' => '');
	}
	function getBudgets (){
		global $mysql;
		$res= array();
		$arr = $mysql->DBGetSomeRows("`Budget`", "*", " where `isDeleted` = 'false' ");
		foreach($arr as $key => $val) {
			$res[$key]['projectName'] = urlencode($val['projectName']);
			$res[$key]['budgetId'] = urlencode($val['budgetId']);
			$res[$key]['custName'] = urlencode($val['custName']);
			$res[$key]['areaSize'] = urlencode($val['areaSize']);
			$res[$key]['totalFee'] = urlencode($val['totalFee']);
			$res[$key]['comments'] = urlencode($val['comments']);
		}
		return $res;
	}
	
	function getBudgetsByBudgetId ($budgetId){
		global $mysql;
		$res= array();
		$arr = $mysql->DBGetSomeRows("`Budget`", "*", "where `budgetId` = '$budgetId' ");
		foreach($arr as $key => $val) {
			$res[$key]['projectName'] = urlencode($val['projectName']);
			$res[$key]['budgetId'] = urlencode($val['budgetId']);
			$res[$key]['custName'] = urlencode($val['custName']);
			$res[$key]['areaSize'] = urlencode($val['areaSize']);
			$res[$key]['totalFee'] = urlencode($val['totalFee']);
			$res[$key]['comments'] = urlencode($val['comments']);
		}
		return $res;
	}
	
	function getBudgetsByProjectName ($projectName){
		global $mysql;
		$res= array();
		$arr = $mysql->DBGetSomeRows("`budget`", "*", "where `projectName` = '$projectName' and `isDeleted` = 'false' ");
		foreach($arr as $key => $val) {
			$res[$key]['projectName'] = urlencode($val['projectName']);
			$res[$key]['budgetId'] = urlencode($val['budgetId']);
			$res[$key]['custName'] = urlencode($val['custName']);
			$res[$key]['areaSize'] = urlencode($val['areaSize']);
			$res[$key]['totalFee'] = urlencode($val['totalFee']);
			$res[$key]['comments'] = urlencode($val['comments']);
		}
		return $res;
	}

	function editBudget (array $pro){
		global $mysql;
		$setValue = "";
		foreach ($pro as $key => $val) {
			if ($key == "budgetId" || is_numeric ($key)) {
				continue;
			} else {
				$setValue .= " `".$key."` = '".$val."',";
			}
		}
		$setValue = substr($setValue, 0, -1);
		$condition = "`budgetId` = '".$pro['budgetId']."'";
		$mysql->DBUpdateSomeCols("`Budget`", $condition, $setValue);
		return array('status'=>'successful', 'errMsg' => '');
	}
?>