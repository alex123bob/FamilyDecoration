<!DOCTYPE HTML>
<html>
<head>
	<meta http-equiv="content-type" content="text/html;charset=utf-8">
    <title>test</title>
	<link rel="stylesheet" href="jquery-ui.css">
	<script src="jquery-2.1.1.min.js"></script>
	<script src="jquery-ui.js"></script>
	<script>
	
	String.prototype.trim=function(){
　　    return this.replace(/(^\s*)|(\s*$)/g, "");
　　 }
	
	var availableTags = {
		keys : [
				"/fd/libs/",
				"/fd/libs/budget.php?action=",
				"/fd/libs/budget.php?action=add",
				"/fd/libs/budget.php?action=list",
				"/fd/libs/budget.php?action=addItem",
				"/fd/libs/budget.php?action=deleItem",
				"/fd/libs/budget.php?action=edit",
				"/fd/libs/budget.php?action=view",
				"/fd/libs/budget.php?action=delete",
				"/fd/libs/budget.php?action=getBudgetsByProjectName"
			]
	};
	availableTags.getKeys = function(){
		var keys = availableTags.keys;
		try{
			keys = JSON.parse(localStorage.getItem("autoCompleteKeys"));
		}catch(e){};
		return keys;
	}
	availableTags.addKey = function(key){
		this.keys.push(key);
		var keysForStore = [];
		var tmpObj = {};
		for(var i in this.keys){
			tmpObj[this.keys[i]] = "keysss";
		}
		for(var i in tmpObj){
			if(tmpObj[i] == "keysss"){
				keysForStore.push(i);
			}
		}
		$("#url").autocomplete( "option", "source",keysForStore);
		try{ localStorage.setItem("autoCompleteKeys",JSON.stringify(keysForStore)); }catch(e){};

		
	}
	
	$(function(){
		urlAutoComplete = $( "#url" ).autocomplete({ source: availableTags.getKeys() });

		$("#data").on("keydown",function(e){
			warn("#data",true);
			if(e.keyCode=="9"){
				var index = $("#data")[0].selectionStart;
				var value = $("#data").val();
				value = value.substring(0,index)+"    "+value.substring(index);
				$("#data").val(value)[0].setSelectionRange(index+4,index+4);
				return false;
			};
		});
		$("#url").on("keydown",function(){
			warn("#url",true);
		});
	});
	
	function warn($selector,isClear){
		if(isClear){
			$($selector).removeClass("warn");
			return;
		}
		var $dom = $($selector);
		$dom.removeClass("warn");
		setTimeout(function(){$dom.addClass("warn")},100);		
		setTimeout(function(){$dom.removeClass("warn")},200);
		setTimeout(function(){$dom.addClass("warn")},300);
		setTimeout(function(){$dom.focus()},400);
	}
	function testClick(){
		log();
		var value = $("#data").val();
		var url = $("#url").val();
		var method = $('input:radio[name="method"]:checked').val();
		if(url == null || url.trim() == ""){
			error("url 为空!");
			warn("#url");
			return false;
		}
		availableTags.addKey(url);
		if(value != null && value.trim() != ""){
			value = "window.tmpvalue = "+value;
		}
		try{
			eval(value);
		}catch(e){
			error("数据有错："+e.message);
			warn("#data");
			return;
		}
		var ajaxObj = { 
					url: url, 
					method:method,
					cache:false,
					complete: function(res){
								try{
									res = JSON.parse(res);
									var logFunc = res.status == "failing" ? error: log;
									res = JSON.stringify(res, null, '\t').replace(/\t/gi,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/\n/gi,"<br />");
									logFunc(res);
								}catch(ex){
									log(res);
								}
							}
				};
		if(typeof tmpvalue != "undefined"){
			ajaxObj.data = tmpvalue;
		}
		$.ajax(ajaxObj);
	}
	
	function log(msg){
		if(typeof msg == "undefined"){
			msg = "";
		}
		$("#msg").html(msg);
	}
	function error(msg){
		$("#msg").html("<font color='red'>"+msg+"</font>");
	}
	</script>
	<style>
		#msg{margin:50px auto auto 50px;float:left;width:600px;height:400px;white-space:normal;word-break:break-all;}
		#main{margin:50px;float:left;}
		label:hover{cursor:pointer;}
		#url{width:400px;}
		.warn{border: #f00 2px solid;}
		*:focus{outline:none;}
		#data{min-width:400px;min-height:200px;margin-left:40px;}
	</style>
</head>
<body>
	<div id="msg"></div>
	<div id="main">
		<div class="ui-widget"><label for="tags">url: </label><input type="text" name="url" id="url"/></div>
		<div class="ui-widget" unselectable="on" onselectstart="return false;" style="-moz-user-select:none;">method:
			<label for="method_post" ><input checked="checked" type="radio" id="method_post" value="post" name="method"/>post</label>
			<label for="method_get" ><input type="radio" id="method_get" value="get" name="method"/>get</label>
		</div>
		<div class="ui-widget">data:</div>
		<div class="ui-widget"><textarea onscroll="this.rows++;" id="data"></textarea></div>
		<div class="ui-widget" style="text-align:right;"><input type="button" value="test" onclick="testClick()"/></div>
	</div>
</body>
</html>
